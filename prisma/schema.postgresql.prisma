// PostgreSQL configuration for Vercel Postgres, Supabase, etc.

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DATABASE_URL_NON_POOLING")
}

model User {
  id                String    @id @default(cuid())
  email             String    @unique
  username          String    @unique
  password          String
  role              String    @default("USER")
  emailVerified     Boolean   @default(false)
  verificationToken String?   @unique
  verificationExpiry DateTime? @db.Timestamptz
  resetToken        String?   @unique
  resetTokenExpiry  DateTime? @db.Timestamptz
  apiToken          String?   @unique
  apiTokenCreatedAt DateTime? @db.Timestamptz
  projects          Project[]
  createdAt         DateTime  @default(now()) @db.Timestamptz
  updatedAt         DateTime  @updatedAt @db.Timestamptz
}

model Project {
  id              String    @id @default(cuid())
  name            String
  apiKey          String    @unique @default(uuid())
  currentVersion  String?
  userId          String
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  versions        Version[]
  apiRequests     ApiRequest[]
  createdAt       DateTime  @default(now()) @db.Timestamptz
  updatedAt       DateTime  @updatedAt @db.Timestamptz
}

model Version {
  id              String   @id @default(cuid())
  projectId       String
  project         Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  version         String
  downloadUrl     String
  downloadUrls    String   @default("[]")
  urlRotationIndex Int     @default(0)
  md5             String
  forceUpdate     Boolean  @default(false)
  changelog       String   @db.Text
  isCurrent       Boolean  @default(false)
  createdAt       DateTime @default(now()) @db.Timestamptz
  updatedAt       DateTime @updatedAt @db.Timestamptz

  @@unique([projectId, version])
}

model SystemConfig {
  id          String   @id @default(cuid())
  key         String   @unique
  value       String   @db.Text
  type        String
  category    String
  description String?  @db.Text
  createdAt   DateTime @default(now()) @db.Timestamptz
  updatedAt   DateTime @updatedAt @db.Timestamptz
  
  @@index([category])
}

model ApiRequest {
  id         String   @id @default(cuid())
  projectId  String?
  project    Project? @relation(fields: [projectId], references: [id], onDelete: SetNull)
  endpoint   String
  method     String
  statusCode Int
  responseTime Int
  userAgent  String?  @db.Text
  ipAddress  String?
  createdAt  DateTime @default(now()) @db.Timestamptz
  
  @@index([projectId])
  @@index([endpoint])
  @@index([createdAt])
}

model EmailLog {
  id        String   @id @default(cuid())
  toEmail   String   
  subject   String
  type      String
  status    String
  error     String?  @db.Text
  createdAt DateTime @default(now()) @db.Timestamptz
  
  @@index([type])
  @@index([status])
  @@index([createdAt])
}